name: 🐳 Docker Lint & Scan

on:
  push:

jobs:
  docker-lint-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Lint Dockerfile with hadolint CLI ---
      - name: Lint Dockerfile
        run: |
          echo "🔍 Running Hadolint on Dockerfile..."
          docker run --rm -i hadolint/hadolint < Dockerfile

      # --- Build image once ---
      - name: Build Docker image
        run: |
          echo "🛠️ Building Docker image: demo-app:latest"
          docker build -t demo-app:latest .

      # --- Trivy scan existing image ---
      - name: Scan image with Trivy
        run: |
          echo "🧪 Scanning built image with Trivy..."
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image demo-app:latest